import 'package:flutter/material.dart';
import 'dart:math';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:lucide_icons/lucide_icons.dart';
import 'package:flutter_background_service/flutter_background_service.dart';
import 'radar_animation.dart';
import '../../../shared/ui/glass_card.dart';
import '../../../shared/ui/liquid_nav_bar.dart'; // Import LiquidNavBar
import '../../matches/data/match_repository.dart';
import '../../matches/presentation/match_dialog.dart';
import '../../settings/presentation/settings_screen.dart';
import '../../map/presentation/pulse_map_screen.dart';
import 'package:google_fonts/google_fonts.dart';
import '../../matches/presentation/matches_screen.dart';
import '../../../shared/ui/primary_button.dart';
import '../../auth/data/auth_repository.dart';

final isScanningProvider =
    StateProvider<bool>((ref) => false); // Manual Toggle State

// Simulates match ping distance (1.0 = edge, 0.0 = center, null = no ping)
final pingDistanceProvider = StateProvider<double?>((ref) => null);

class HomeScreen extends ConsumerWidget {
  const HomeScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // Listen to the stream and update controller
    ref.listen(matchStreamProvider, (prev, next) {
      final isScanning = ref.read(isScanningProvider);
      if (!isScanning) return; // Only match when radar is active

      next.whenData((match) {
        if (match != null) {
          ref.read(matchControllerProvider.notifier).setMatch(match);
        }
      });
    });

    // Listen to controller to show dialog
    ref.listen(matchControllerProvider, (prev, match) {
      if (match != null) {
        showGeneralDialog(
          context: context,
          pageBuilder: (ctx, a1, a2) => MatchDialog(match: match),
          barrierDismissible: true,
          barrierLabel: "Dismiss",
          barrierColor: Colors.black54,
          transitionDuration: const Duration(milliseconds: 200),
        ).then((_) {
          // Ensure controller is cleared if dialog is dismissed via barrier
          ref.read(matchControllerProvider.notifier).dismiss();
        });
      }
    });

    final user = ref.watch(authStateProvider);
    final navIndex = ref.watch(navIndexProvider);
    final isScanning = ref.watch(isScanningProvider);
    final pingDistance = ref.watch(pingDistanceProvider);
    final bool canAccessRadar =
        user?.isEmailVerified == true || user?.isAdmin == true;
    final bool isPremium = user?.isPremium == true;

    // Define Screens and Nav Items
    final List<Widget> screens;
    final List<LiquidNavItem> navItems;

    if (isPremium) {
      screens = [
        _buildRadarView(
            ref, context, canAccessRadar, isScanning, isPremium, pingDistance),
        const PulseMapScreen(),
        const MatchesScreen(),
        const SettingsScreen(),
      ];
      navItems = [
        LiquidNavItem(icon: LucideIcons.radar, label: 'Radar'),
        LiquidNavItem(icon: LucideIcons.map, label: 'Map'),
        LiquidNavItem(icon: LucideIcons.users, label: 'Matches'),
        LiquidNavItem(icon: LucideIcons.settings, label: 'Settings'),
      ];
    } else {
      screens = [
        _buildRadarView(
            ref, context, canAccessRadar, isScanning, isPremium, pingDistance),
        const MatchesScreen(),
        const SettingsScreen(),
      ];
      navItems = [
        LiquidNavItem(icon: LucideIcons.radar, label: 'Radar'),
        LiquidNavItem(icon: LucideIcons.users, label: 'Matches'),
        LiquidNavItem(icon: LucideIcons.settings, label: 'Settings'),
      ];
    }

    return Stack(
      children: [
        // Content with Liquid Transition
        Positioned.fill(
          child: AnimatedSwitcher(
            duration: const Duration(milliseconds: 500),
            switchInCurve: Curves.easeOutQuart,
            switchOutCurve: Curves.easeInQuart,
            transitionBuilder: (Widget child, Animation<double> animation) {
              return FadeTransition(
                opacity: animation,
                child: ScaleTransition(
                  scale:
                      Tween<double>(begin: 0.95, end: 1.0).animate(animation),
                  child: child,
                ),
              );
            },
            child: KeyedSubtree(
              key: ValueKey<int>(navIndex),
              child: screens[navIndex],
            ),
          ),
        ),

        // Floating Liquid Navigation Bar
        Positioned(
          bottom: 30,
          left: 0,
          right: 0,
          child: LiquidNavBar(
            currentIndex: navIndex,
            isPremium: isPremium,
            items: navItems,
            onTap: (index) {
              ref.read(navIndexProvider.notifier).state = index;
            },
          ),
        ),
      ],
    );
  }

  Widget _buildRadarView(
      WidgetRef ref,
      BuildContext context,
      bool canAccessRadar,
      bool isScanning,
      bool isPremium,
      double? pingDistance) {
    return Stack(
      children: [
        // Radar View (Conditional)
        canAccessRadar
            ? Stack(
                children: [
                  Positioned.fill(
                      child: RadarAnimation(
                    isScanning: isScanning,
                    pingDistance: pingDistance,
                    pingAngle: pi / 4,
                  )),
                  Center(
                    child: GestureDetector(
                      onTap: () {
                        final newState = !isScanning;
                        ref.read(isScanningProvider.notifier).state = newState;

                        if (newState) {
                          debugPrint(
                              "üìç Location Captured: mock_lat: 46.05, mock_lng: 14.50 [Ljubljana]");
                          // In real app, call Location Service here
                          FlutterBackgroundService().startService();
                        } else {
                          // Stop service? Or just let it run but stop notifying?
                          // Simply invoking stop might kill the isolate
                          // FlutterBackgroundService().invoke("stopService");
                        }
                      },
                      child: GlassCard(
                        opacity: 0.1,
                        borderRadius: 100,
                        padding: const EdgeInsets.all(30),
                        child: Icon(
                            isScanning ? LucideIcons.radio : LucideIcons.play,
                            size: 60,
                            color: isScanning ? Colors.white : Colors.white70),
                      ),
                    ),
                  ),
                  if (isScanning)
                    Positioned(
                      bottom: 140,
                      left: 0,
                      right: 0,
                      child: Center(
                        child: Text(
                          "Skeniranje...",
                          style: TextStyle(
                              color: Colors.white.withValues(alpha: 0.7),
                              letterSpacing: 2),
                        ),
                      ),
                    )
                ],
              )
            : Center(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    const Icon(LucideIcons.lock,
                        size: 60, color: Colors.white54),
                    const SizedBox(height: 20),
                    Text(
                      "Radar je zaklenjen.",
                      style: GoogleFonts.outfit(
                          color: Colors.white,
                          fontSize: 24,
                          fontWeight: FontWeight.bold),
                    ),
                    const SizedBox(height: 10),
                    const Text(
                      "Prosim preveri svoj email za dostop.",
                      style: TextStyle(color: Colors.white70),
                    ),
                    const SizedBox(height: 20),
                    PrimaryButton(
                      text: "Pojdi v nastavitve",
                      width: 200,
                      onPressed: () {
                        ref.read(navIndexProvider.notifier).state =
                            isPremium ? 3 : 2; // Settings index varies
                      },
                    )
                  ],
                ),
              ),
      ],
    );
  }
}

final navIndexProvider = StateProvider<int>((ref) => 0);
